<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="favicon.ico">
    <meta name="theme-color" content="#e4e6ef">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js')
          .catch(e => console.error('Service Worker registration failed:', e));
      }
    </script>
    <title>CBTç­”æ¡ˆã‚¨ãƒ‡ã‚£ã‚¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
    body {
      margin: 0;
      background: #f7f8fa;
      font-family: "MS Mincho", "Hiragino Mincho ProN", "Noto Serif", serif;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background-color: #e4e6ef;
      padding: 8px 16px;
      font-size: 14px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      border-bottom: 1px solid #ccc;
    }
    #editor-box {
      position: relative;
      padding: 16px 16px 16px 60px;
      width: fit-content;
      margin: auto;
    }
    textarea {
      width: 900px;
      height: 90vh;
      font-size: 27px;
      font-family: "MS Mincho", "Hiragino Mincho ProN", "Noto Serif", serif;
      line-height: 51px;
      box-sizing: border-box;
      border: none;
      outline: none;
      padding: 0;
      background-image: repeating-linear-gradient(to bottom, transparent, transparent 50px, #ccc 50px, #ccc 51px);
      background-attachment: local;
      background-clip: padding-box;
      resize: none;
      white-space: pre-wrap;
      overflow-y: none;
    }
    .line-numbers {
      position: absolute;
      top: 16px;
      left: 16px;
      font-size: 18px;
      color: #d088d2;
      line-height: 51px;
      white-space: pre;
      font-family: monospace;
      text-align: center;
    }
    .screen { display: none; }
    .screen.active { display: block; }
    </style>
  </head>
  <body>
    <div id="start-screen" class="screen active container py-4">
      <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
          <button class="nav-link active" id="new-form-tab" data-bs-toggle="tab" data-bs-target="#new-form">æ–°è¦ç­”æ¡ˆä½œæˆ</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#load-form">ç­”æ¡ˆèª­ã¿è¾¼ã¿</button>
        </li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="new-form">
          <form id="config-form">
            <div class="mb-3">
              <label class="form-label">è©¦é¨“ç¨®åˆ¥</label>
              <select id="exam-type" class="form-select">
                <option value="å¸æ³•è©¦é¨“">å¸æ³•è©¦é¨“</option>
                <option value="äºˆå‚™è©¦é¨“">äºˆå‚™è©¦é¨“</option>
                <option value="æ—§å¸æ³•è©¦é¨“">æ—§å¸æ³•è©¦é¨“</option>
                <option value="ãã®ä»–">ãã®ä»–ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</option>
              </select>
            </div>
            <div class="mb-3" id="year-group">
              <label class="form-label">å¹´åº¦</label>
              <input type="text" id="exam-year" class="form-control" placeholder="ä¾‹ï¼šä»¤å’Œ6å¹´">
            </div>
            <div class="mb-3" id="custom-group" style="display: none;">
              <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</label>
              <input type="text" id="custom-exam-name" class="form-control" placeholder="ä¾‹ï¼šè¾°å·²å…¬é–‹æ¨¡è©¦ æ†²æ³• ç¬¬1å•">
            </div>
            <div class="mb-3" id="subject-group">
              <label class="form-label">ç§‘ç›®</label>
              <select id="exam-subject" class="form-select">
                <optgroup label="å¿…é ˆç§‘ç›®">
                  <option value="æ†²æ³•">æ†²æ³•</option>
                  <option value="æ°‘æ³•">æ°‘æ³•</option>
                  <option value="åˆ‘æ³•">åˆ‘æ³•</option>
                  <option value="å•†æ³•">å•†æ³•</option>
                  <option value="æ°‘äº‹è¨´è¨Ÿæ³•">æ°‘äº‹è¨´è¨Ÿæ³•</option>
                  <option value="åˆ‘äº‹è¨´è¨Ÿæ³•">åˆ‘äº‹è¨´è¨Ÿæ³•</option>
                  <option value="è¡Œæ”¿æ³•">è¡Œæ”¿æ³•</option>
                </optgroup>
                <optgroup label="é¸æŠç§‘ç›®">
                  <option value="åŠ´åƒæ³•">åŠ´åƒæ³•</option>
                  <option value="çµŒæ¸ˆæ³•">çµŒæ¸ˆæ³•</option>
                  <option value="å€’ç”£æ³•">å€’ç”£æ³•</option>
                  <option value="çŸ¥çš„è²¡ç”£æ³•">çŸ¥çš„è²¡ç”£æ³•</option>
                  <option value="ç§Ÿç¨æ³•">ç§Ÿç¨æ³•</option>
                  <option value="ç’°å¢ƒæ³•">ç’°å¢ƒæ³•</option>
                  <option value="å›½éš›é–¢ä¿‚æ³•ï¼ˆå…¬æ³•ç³»ï¼‰">å›½éš›é–¢ä¿‚æ³•ï¼ˆå…¬æ³•ç³»ï¼‰</option>
                  <option value="å›½éš›é–¢ä¿‚æ³•ï¼ˆç§æ³•ç³»ï¼‰">å›½éš›é–¢ä¿‚æ³•ï¼ˆç§æ³•ç³»ï¼‰</option>
                </optgroup>
              </select>
            </div>
            <div class="mb-3" id="qnum-group">
              <label class="form-label">å¤§å•ç•ªå·</label>
              <input type="number" id="question-number" class="form-control" placeholder="ä¾‹ï¼š1" min="1">
            </div>
            <div class="mb-4">
              <label class="form-label">è¡Œæ•°åˆ¶é™</label>
              <select id="line-limit" class="form-select">
                <option value="184">184è¡Œ</option>
                <option value="92">92è¡Œ</option>
                <option value="88">88è¡Œ</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">ç­”æ¡ˆä½œæˆã‚’é–‹å§‹</button>
          </form>
        </div>
        <div class="tab-pane fade" id="load-form">
          <div class="mb-3">
            <label class="form-label">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
            <input type="file" id="json-input" class="form-control" accept=".json">
          </div>
        </div>
      </div>
    </div>

    <div id="editor-screen" class="screen">
      <header>
        <div>
          <span id="counter">0/0è¡Œ 0/0æ–‡å­—ï¼ˆç©ºç™½å«ã‚€ï¼‰</span>
          <button id="txt-btn" class="btn btn-outline-secondary btn-sm ms-2">ğŸ“„ ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ä¿å­˜</button>
          <button id="finish-btn" class="btn btn-outline-secondary btn-sm ms-3">çµ‚äº†</button>
        </div>
      </header>
      <div id="editor-box">
        <div class="line-numbers" id="lines"></div>
        <textarea id="textarea" spellcheck="false"></textarea>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const textarea = document.getElementById("textarea");
      const counter = document.getElementById("counter");
      const lines = document.getElementById("lines");
      const startScreen = document.getElementById("start-screen");
      const editorScreen = document.getElementById("editor-screen");
      const examType = document.getElementById("exam-type");
      const yearGroup = document.getElementById("year-group");
      const customGroup = document.getElementById("custom-group");
      const subjectGroup = document.getElementById("subject-group");
      const qnumGroup = document.getElementById("qnum-group");
      const finishBtn = document.getElementById("finish-btn");
      const jsonInput = document.getElementById("json-input");

      let maxLines = 184;
      let maxChars = 5520;
      let isComposing = false;
      let examData = {};

      examType.addEventListener("change", () => {
        if (["å¸æ³•è©¦é¨“", "äºˆå‚™è©¦é¨“", "æ—§å¸æ³•è©¦é¨“"].includes(examType.value)) {
          yearGroup.style.display = "block";
          customGroup.style.display = "none";
          subjectGroup.style.display = "block";
          qnumGroup.style.display = "block";
        } else {
          yearGroup.style.display = "none";
          customGroup.style.display = "block";
          subjectGroup.style.display = "none";
          qnumGroup.style.display = "none";
        }
      });

      function toFullWidth(str) {
        return str.replace(/[!-~]/g, c => String.fromCharCode(c.charCodeAt(0) + 0xFEE0));
      }

      function autoBreak(text) {
        const full = toFullWidth(text).replace(/\r/g, "");
        const lines = full.split("\n");
        const adjustedLines = [];
        for (const line of lines) {
          adjustedLines.push(...(line.match(/.{1,30}/g) ?? [""]));
        }
        return adjustedLines.join("\n");
      }

      function update() {
        if (isComposing) return;
        const pos = textarea.selectionStart;
        const original = textarea.value;
        const preText = original.slice(0, pos);
        const updated = autoBreak(original);
        textarea.value = updated;
        const adjusted = autoBreak(preText);
        const newPos = adjusted.length;
        textarea.setSelectionRange(newPos, newPos);
        const rows = textarea.value.split("\n");
        const charCount = textarea.value.length;
        const lineCount = rows.length;
        counter.textContent = `${lineCount}/${maxLines}è¡Œ ${charCount}/${maxChars}æ–‡å­—ï¼ˆç©ºç™½å«ã‚€ï¼‰`;
        lines.textContent = Array.from({ length: lineCount }, (_, i) => i + 1).join("\n");
      }

      document.getElementById("config-form").addEventListener("submit", e => {
        e.preventDefault();
        const type = examType.value;
        const isFree = type === "ãã®ä»–";
        const year = isFree ? null : document.getElementById("exam-year").value;
        const custom = isFree ? document.getElementById("custom-exam-name").value : null;
        const subject = isFree ? null : document.getElementById("exam-subject").value;
        const qNum = isFree ? null : parseInt(document.getElementById("question-number").value || "1");

        maxLines = parseInt(document.getElementById("line-limit").value);
        maxChars = maxLines * 30;

        examData = { exam_type: type, exam_year: year, custom_exam_name: custom, subject, question_number: qNum, line_limit: maxLines, char_limit: maxChars };
        document.title = isFree ? custom : `${type} ${year} ${subject} ç¬¬${qNum}å•`;
        startScreen.classList.remove("active");
        editorScreen.classList.add("active");
        update();
      });

      textarea.addEventListener("input", update);
      textarea.addEventListener("compositionstart", () => isComposing = true);
      textarea.addEventListener("compositionend", () => { isComposing = false; update(); });
      textarea.addEventListener("keydown", e => {
        if (e.ctrlKey && ["z","Z","c","C","x","X","a","A"].includes(e.key)) e.preventDefault();
      });

      finishBtn.addEventListener("click", () => {
        const data = { ...examData, content: textarea.value };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const a = document.createElement("a");

        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        const dd = String(now.getDate()).padStart(2, "0");
        const hh = String(now.getHours()).padStart(2, "0");
        const mi = String(now.getMinutes()).padStart(2, "0");
        const timestamp = `${yyyy}${mm}${dd}_${hh}${mi}`;

        const titleText = document.title.replace(/\s+/g, "").replace(/[\\/:*?"<>|]/g, "_");
        a.href = URL.createObjectURL(blob);
        a.download = `${titleText}_${timestamp}.json`;
        a.click();

        // âœ… beforeunload ã®è­¦å‘Šã‚’è§£é™¤
        window.onbeforeunload = null;

        // âœ… åˆæœŸç”»é¢ã«æˆ»ã™
        textarea.value = "";
        document.title = "CBTç­”æ¡ˆã‚¨ãƒ‡ã‚£ã‚¿";
        counter.textContent = `0/${maxLines}è¡Œ 0/${maxChars}æ–‡å­—ï¼ˆç©ºç™½å«ã‚€ï¼‰`;
        lines.textContent = "";

        editorScreen.classList.remove("active");
        startScreen.classList.add("active");

        // âœ… ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        document.getElementById("config-form").reset();

        // âœ… ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ¬„ãƒªã‚»ãƒƒãƒˆ
        document.getElementById("json-input").value = "";

        // âœ… ã‚¿ãƒ–ã‚’ã€Œæ–°è¦ç­”æ¡ˆä½œæˆã€ã«æˆ»ã™
        const tabTrigger = new bootstrap.Tab(document.querySelector('#new-form-tab'));
        tabTrigger.show();
      });

      jsonInput.addEventListener("change", e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function () {
          const data = JSON.parse(reader.result);
          const isFree = data.exam_type === "ãã®ä»–";
          examData = data;
          maxLines = data.line_limit;
          maxChars = data.char_limit;
          textarea.value = data.content || "";
          document.title = isFree ? data.custom_exam_name : `${data.exam_type} ${data.exam_year} ${data.subject} ç¬¬${data.question_number}å•`;
          startScreen.classList.remove("active");
          editorScreen.classList.add("active");
          update();
        };
        reader.readAsText(file);
      });

      window.addEventListener("beforeunload", function (e) {
        if (editorScreen.classList.contains("active")) {
          e.preventDefault();
          e.returnValue = "";
        }
      });

      window.addEventListener("keydown", function (e) {
        const isEditing = editorScreen.classList.contains("active");
        const isReloadKey =
          e.key === "F5" ||
          (e.ctrlKey && e.key.toLowerCase() === "r") ||
          (e.metaKey && e.key.toLowerCase() === "r");

        if (isEditing && isReloadKey) {
          e.preventDefault();
          alert("ãƒšãƒ¼ã‚¸ã®å†èª­ã¿è¾¼ã¿ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚å¿…ãšçµ‚äº†ãƒœã‚¿ãƒ³ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
        }
      });

      function adjustTextareaWidth() {
        const ruler = document.createElement("span");
        ruler.textContent = "ã‚"; // å…¨è§’1æ–‡å­—
        ruler.style.visibility = "hidden";
        ruler.style.position = "absolute";
        ruler.style.whiteSpace = "pre";
        ruler.style.display = "inline-block";
        ruler.style.fontFamily = getComputedStyle(textarea).fontFamily;
        ruler.style.fontSize = getComputedStyle(textarea).fontSize;
        document.body.appendChild(ruler);

        const charWidth = ruler.getBoundingClientRect().width;
        textarea.style.width = (charWidth * 30) + "px";

        document.body.removeChild(ruler);
      }

      window.addEventListener("load", () => {
        update();
        adjustTextareaWidth();
        adjustTextareaHeight();
      });
      document.getElementById("txt-btn").addEventListener("click", () => {
        const title = document.title.replace(/\s+/g, "").replace(/[\\/:*?"<>|]/g, "_");
        const content = textarea.value;
        const blob = new Blob([content], { type: "text/plain" });

        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${title}.txt`;
        a.click();
      });

      const lineHeight = 51; // CSSã¨ä¸€è‡´ã•ã›ã‚‹

      textarea.addEventListener("scroll", () => {
        const remainder = textarea.scrollTop % lineHeight;
        if (remainder !== 0) {
          textarea.scrollTop -= remainder;
        }
      });
      function adjustTextareaHeight() {
        textarea.style.height = (maxLines * lineHeight) + "px";
      }
    </script>
  </body>
</html>
<!--
  vim:et:ts=2:sts=2:sw=2
-->
